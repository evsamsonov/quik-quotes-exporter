# Экспортер котировок из торгового терминала QUIK

Экспортирует часовые свечи и обезличенные сделки из терминала QUIK по группе инструментов. Отправляет данные по протоколу JSON-RPC через [jsonrpc-fsproxy](https://github.com/evsamsonov/jsonrpc-fsproxy). Не требует установки дополнительных Lua библиотек. Есть функционал оповещения о возникающих в работе скрипта проблемах

## Описание

После запуска единоразово отправляет все сделки, которые есть на данный момент в таблице обезличенных сделок. В начале каждого часа отправляет информацию с последней доступной свечи на сервере до текущей. Подписывается на обновление по обезличенным сделкам и отправляет их пачкой раз в минуту. При проблемах с отправкой данных о свечах или обезличенных сделкамх на сервер делает 3 попытки, если отправить запрос не удалось оповещает о проблеме, но продолжает работу и в следующем цикле отправляет запросы вновь 

## Как запустить 

- Переименовать `config.lua.dist` в `config.lua` и настроить конфигурацию
- Запустить утилиту jsonrpc-fsproxy с указанием корректного адреса JSON-RPC сервера и файлов обмена данными
- Открыть в терминале QUIK окно Доступные скрипты через меню Сервисы->Lua скрипты...
- Добавить файл main.lua и запустить

## Конфигурация 

```lua
local QuikQuotesExporter = require('src/quik_quotes_exporter')
return {
    rpcClient = {
        -- Файл для отправки запроса. 
        -- Переменная окружения INPUT_FILE_PATH, заданная при запуске jsonrpc-fsproxy 
        requestFilePath = 'Z:\\dev\\rpcin',  
        
        -- Файл для получения ответа
        -- Переменная окружения OUTPUT_FILE_PATH, заданная при запуске jsonrpc-fsproxy 
        responseFilePath = 'Z:\\dev\\rpcout',   
        
        -- Префикс идентификатора RPC запроса (по умолчанию пустая строка). 
        -- Требуется только в случае, когда указанные выше файлы используются 
        -- для работы других скриптов, чтобы различать ответы сервера
        idPrefix = 'qe'                         
    },
    instruments = {
        {
            -- Рынок для идентификации на стороне сервера. Любое значение??
            market = QuikQuotesExporter.MOSCOW_EXCHANGE_MARKET,    
            
            -- Идентификатор режима торгов и код ценной бумаги 
            -- Можно найти на странице конкретного торгового инструмента 
            -- на сайте Московской биржи или в таблице котировок QUIK (параметр "Код класса")
            classCode = 'TQBR',                                    
            secCode = 'SBER',     
            
            -- Интервал. Сейчас доступен только часовой                              
            interval = INTERVAL_H1,                                
        }
    },
    -- Часы работы скрита. Если не задан, то время работы неограничено
    workingHours = {
        start = 10,
        finish = 23,
    }
}
```

## Описание сервера

JSON-RPC сервер должен реализовывать следующие методы:

### Получение последней известной свечи
Quotes.GetLastCandle

todo Пример запроса и ответа

### Добавление свечи
Quotes.AddCandle

### Добавление тиков
Quotes.AddTicks

### Отправка уведомления
Notification.Notify

## Особенности

Обезличенные сделки заказ

## Задачи
Добавить другие периоды

