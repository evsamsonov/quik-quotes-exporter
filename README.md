# Экспортер котировок из торгового терминала QUIK

Экспортирует часовые свечи и обезличенные сделки из терминала QUIK по группе инструментов. Отправляет данные по протоколу [JSON-RPC 2.0](https://www.jsonrpc.org/specification) через [jsonrpc-fsproxy](https://github.com/evsamsonov/jsonrpc-fsproxy). Не требует установки дополнительных Lua библиотек. Есть функционал оповещения о возникающих в работе скрипта проблемах

## Описание

### Отправка свечей 

При запуске и в начале каждого часа отправляет информацию с последней доступной свечи на сервере до текущей.

### Отправка обезличенных сделок

После запуска единоразово отправляет все сделки, которые есть на данный момент в таблице обезличенных сделок. Подписывается на обновление по обезличенным сделкам и отправляет их пачкой раз в минуту. 

### Поведение при ошибках отправки данных

При проблемах с отправкой данных о свечах или обезличенных сделкамх на сервер делает 3 попытки, если отправить запрос не удалось оповещает о проблеме, но продолжает работу и в следующем цикле пытается отправить запросы вновь.

## Как запустить 

- Переименовать `config.lua.dist` в `config.lua` и настроить конфигурацию
- Запустить утилиту jsonrpc-fsproxy с указанием корректного адреса JSON-RPC сервера и файлов обмена данными
- Открыть в терминале QUIK окно Доступные скрипты через меню Сервисы->Lua скрипты...
- Добавить файл main.lua и запустить

## Конфигурация 

```lua
local QuikQuotesExporter = require('src/quik_quotes_exporter')
return {
    rpcClient = {
        -- Файл для отправки запроса. 
        -- Переменная окружения INPUT_FILE_PATH, заданная при запуске jsonrpc-fsproxy 
        requestFilePath = 'Z:\\dev\\rpcin',  
        
        -- Файл для получения ответа
        -- Переменная окружения OUTPUT_FILE_PATH, заданная при запуске jsonrpc-fsproxy 
        responseFilePath = 'Z:\\dev\\rpcout',   
        
        -- Префикс идентификатора RPC запроса (по умолчанию пустая строка). 
        -- Требуется только в случае, когда указанные выше файлы используются 
        -- для работы других скриптов, чтобы различать ответы сервера
        idPrefix = 'qe'                         
    },
    instruments = {
        {
            -- Рынок для идентификации на стороне сервера. Любое значение??
            market = QuikQuotesExporter.MOSCOW_EXCHANGE_MARKET,    
            
            -- Идентификатор режима торгов и код ценной бумаги 
            -- Можно найти на странице конкретного торгового инструмента 
            -- на сайте Московской биржи или в таблице котировок QUIK (параметр "Код класса")
            classCode = 'TQBR',                                    
            secCode = 'SBER',     
            
            -- Интервал. Сейчас доступен только часовой                              
            interval = INTERVAL_H1,                                
        }
    },
    -- Часы работы скрипта. Если не задан, то время работы неограничено
    workingHours = {
        start = 10,
        finish = 23,
    }
}
```

## Описание сервера

JSON-RPC сервер для корректной работы скрипта должен реализовывать следующие методы

### Получение последней известной свечи
Quotes.GetLastCandle

todo Пример запроса и ответа

### Добавление свечи
Quotes.AddCandle

### Добавление тиков
Quotes.AddTicks

### Отправка уведомления

Используется для оповещения о запуске и возникающих ошибках в работе скрипта

Метод: 
```
Notification.Notify
```

Запрос:
```json
{
    "jsonrpc": "2.0",
    "method": "Notification.Notify",
    "params": {
        "message": "2021-02-22 10:09:57: QuikQuotesExporter has been started successfully"
    },
    "id": "1"
}
```

```
curl -H "Content-Type: application/json" -X POST -d  '{"jsonrpc": "2.0", "method": "Notification.Notify", "params":{"message":"2021-02-22 10:09:57: QuikQuotesExporter has been started successfully"}, "id": "1"}'  http://127.0.0.1:8080/rpc```
```

Ответ:
```json
{
   "jsonrpc":"2.0",
   "id":"1",
   "result":{}
}
```

## Особенности

Обезличенные сделки заказ

## Задачи
Добавить другие периоды

